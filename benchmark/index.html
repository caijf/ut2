<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>性能测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/ua-parser-js@1"></script>
    <style>
      table {
        border-collapse: collapse;
        border-spacing: 0;
        width: 100%;
      }

      th,
      td {
        padding: 2px 5px;
        border: 1px solid #ccc;
      }

      thead th {
        background-color: #ddd;
        white-space: nowrap;
      }

      tbody th,
      td {
        word-wrap: break-word;
        word-break: break-all;
      }

      tr.fastest td {
        background-color: #e6eeff;
      }
    </style>
  </head>

  <body>
    <div class="max-w-5xl md:w-full p-5 mx-auto bg-gray-100">
      <h1 class="text-2xl mb-2">性能测试</h1>
      <p class="mb-2">测试 ut2 对比 lodash 和 underscore 的性能。</p>
      <p class="text-sm text-gray-500">工具库版本：<span id="lib-version"></span></p>
      <p class="text-sm text-gray-500">运行环境：<span id="env-info"></span></p>

      <div class="my-5">选择方法：<span id="form"></span></div>

      <div class="case mb-5">
        <h3 class="bg-blue-500 text-white px-5 py-1 font-bold mb-2">Test #1</h3>
        <iframe src="./runner.html" class="w-full border-0" height="500"></iframe>
      </div>
      <div class="case mb-5">
        <h3 class="bg-blue-500 text-white px-5 py-1 font-bold mb-2">Test #2</h3>
        <iframe src="./runner.html" class="w-full border-0" height="500"></iframe>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.6/underscore-umd-min.js"></script>
    <script>
      var underscore = _.noConflict();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <!-- <script src="https://unpkg.com/platform@1/platform.js"></script> -->
    <script src="https://unpkg.com/benchmark@2/benchmark.js"></script>
    <script src="https://unpkg.com/ut2@1/dist/ut2.min.js"></script>
    <!-- <script src="../dist/ut2.min.js"></script> -->
    <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
    <script src="./fastest.js"></script>
    <script>
      const categoryConfig = fastest.config;

      // 添加 select
      const oForm = document.getElementById('form');
      const oSelect = document.createElement('select');
      categoryConfig.forEach(function (item) {
        const oOptgroup = document.createElement('optgroup');
        oOptgroup.setAttribute('label', item.category);

        item.list.forEach(function (subItem) {
          const oOption = document.createElement('option');
          oOption.setAttribute('value', subItem.method);
          oOption.innerHTML = subItem.method;

          oOptgroup.appendChild(oOption);
        });

        oSelect.appendChild(oOptgroup);
      });
      oSelect.value = categoryConfig[0].list[0].method;
      oForm.appendChild(oSelect);

      // 各工具库版本
      const oLibVersion = document.getElementById('lib-version');
      oLibVersion.innerHTML = 'ut2@' + ut2.VERSION + ', lodash@' + _.VERSION + ', underscore@' + underscore.VERSION;

      // 运行环境
      const uaParser = new UAParser();
      const ua = `${uaParser.getBrowser().name} ${uaParser.getBrowser().version} / ${uaParser.getOS().name} ${uaParser.getOS().version}`;
      const oEnv = document.getElementById('env-info');
      oEnv.innerHTML = ua;

      // // 测试
      // const libs = ['underscore', 'lodash', 'ut2'];
      // const oResult = document.getElementById('result');
      // const oTbody = oResult.querySelector('tbody');
      // const oAction = document.getElementById('action');
      // const oRunButton = oAction.querySelector('button');
      // const oTipRunning = document.getElementById('tip-running');

      // oRunButton.addEventListener('click', function () {
      //   run();
      // });

      // function run() {
      //   const method = oSelect.value;

      //   if (!method) {
      //     alert('请选择测试方法');
      //     return;
      //   }

      //   oTbody.innerHTML = '';
      //   oResult.style.display = 'none';
      //   oAction.style.display = 'none';
      //   oTipRunning.style.display = 'block';

      //   setTimeout(function () {
      //     const result = fastest({
      //       Benchmark: Benchmark,
      //       ut2: ut2,
      //       underscore: underscore,
      //       lodash: _,
      //       methods: method
      //     })[method];

      //     oAction.style.display = 'block';
      //     oTipRunning.style.display = 'none';

      //     renderResult(result);
      //   }, 100);
      // }

      // function renderResult(data) {
      //   const fragment = document.createDocumentFragment();

      //   data.forEach(function (item, index) {
      //     libs.forEach(function (libItem, libIndex) {
      //       const tr = document.createElement('tr');

      //       if (libItem === item.$fastest) {
      //         tr.setAttribute('class', 'fastest');
      //       }

      //       if (libIndex === 0) {
      //         const th = document.createElement('th');
      //         th.setAttribute('rowspan', 3);
      //         th.innerHTML = item.$case;
      //         tr.appendChild(th);
      //       }
      //       const td0 = document.createElement('td');
      //       const td1 = document.createElement('td');
      //       const td2 = document.createElement('td');
      //       const td3 = document.createElement('td');
      //       const td4 = document.createElement('td');
      //       const td5 = document.createElement('td');

      //       td0.innerHTML = '<div style="white-space: nowrap;">' + libItem + '</div>';
      //       td1.innerHTML = item[libItem].existed ? item[libItem].case : 'unsupported';
      //       td2.innerHTML = item[libItem].existed ? JSON.stringify(item[libItem].result) : '-';
      //       td3.innerHTML = item[libItem].existed ? item[libItem].hz : '-';
      //       td4.innerHTML = item[libItem].existed ? item[libItem].rme : '-';
      //       td5.innerHTML = item[libItem].existed ? item[libItem].sampled : '-';

      //       tr.appendChild(td0);
      //       tr.appendChild(td1);
      //       tr.appendChild(td2);
      //       tr.appendChild(td3);
      //       tr.appendChild(td4);
      //       tr.appendChild(td5);

      //       fragment.appendChild(tr);
      //     });
      //   });

      //   oTbody.innerHTML = '';
      //   oTbody.appendChild(fragment);
      //   oResult.style.display = 'block';
      // }
    </script>
  </body>
</html>
